# レシピ#4-4: AIによるリファクタリングとテストコード生成

良い料理人は、調理中も常にキッチンを清潔に保ちます。同様に、優れた開発者は、機能を追加しながらもコードを常にクリーンで健全な状態に保ちます。このプロセスが**リファクタリング**と**テスト**です。

このレシピでは、面倒で後回しにされがちなこれらの作業を、AIを「自動クリーニングロボット」や「品質検査員」として活用し、効率的に行う方法を学びます。

---

## 1. リファクタリング：コードをきれいに再構築する

リファクタリングとは、外部から見た振る舞いを変えずに、内部の構造を改善することです。AIは、リファクタリングの定石パターンを熟知しています。

### 例1：巨大なウィジェットを分割する

一つのウィジェットにコードが集中しすぎると、可読性も保守性も著しく低下します。これは「Fat Widget（太ったウィジェット）」と呼ばれ、最も一般的なリファクタリング対象です。

> **🤖 AI活用プロンプト**
>
> あなたは、クリーンで再利用可能なコードを書くのが得意なFlutterのエキスパートです。
>
> 以下のコードは、1つの`build`メソッドの中にUIのロジックが多すぎて読みにくくなっています。
>
> **【改善してほしいコード】**
> ```dart
> // (ここに、長くて複雑なbuildメソッドを持つウィジェットのコードを貼り付ける)
> ```
>
> **要件:**
> - このウィジェットを、複数の小さな、再利用可能なプライベートウィジェット（例: `_buildHeader()`, `_buildBody()`）や、独立した`StatelessWidget`に分割してください。
> - それぞれのウィジェットが、単一の責任を持つように設計してください。
> - リファクタリング後の、すべてのコードを提示してください。

**なぜこれが良いのか？**
*   AIは「単一責任の原則」のような設計原則を理解しており、それに沿って適切にコードを分割してくれます。
*   人間がやると面倒な、コンストラクタでの値の受け渡しなども、ミスなく自動的に処理してくれます。

### 例2：ロジックをUIから分離する

UIウィジェットの中に、ビジネスロジック（計算やデータ加工など）が混在しているのも、よくあるアンチパターンです。

> **🤖 AI活用プロンプト**
>
> 現在、以下のウィジェットの`build`メソッド内に、表示する商品価格を計算するロジックが含まれてしまっています。
>
> **【改善してほしいコード】**
> ```dart
> // (ここに、UIとロジックが混在したコードを貼り付ける)
> ```
>
> **要件:**
> - Riverpodの`Provider`を使って、価格計算のロジックをUIから完全に分離してください。
> - UI側は、そのProviderを`watch`して、計算結果を受け取るだけにしてください。
> - `Provider`を定義するコードと、修正後のUIウィジェットのコードの両方を提示してください。

---

## 2. テストコードの生成：品質を自動で保証する

テストコードを書くことは、アプリの品質を保証し、将来のリファクタリングを容易にするために不可欠ですが、非常に手間のかかる作業でもあります。AIは、この作業を劇的に効率化してくれます。

### 例：シンプルな関数の単体テスト（Unit Test）を生成する

> **🤖 AI活用プロンプト**
>
> あなたは、Flutterのテストフレームワークに精通した品質保証エンジニアです。
>
> 以下のDartの関数に対する、網羅的な**単体テスト（Unit Test）**のコードを生成してください。
>
> **【テスト対象の関数】**
> ```dart
> // utils.dart
> String formatPrice(double price, {String currency = 'JPY'}) {
>   if (price < 0) {
>     throw ArgumentError('Price cannot be negative.');
>   }
>   return '$currency ${price.toStringAsFixed(0)}';
> }
> ```
>
> **要件:**
> - `flutter_test`パッケージを使用してください。
> - 正常なケース（正の価格）と、異常なケース（負の価格でエラーがスローされること）の両方をテストしてください。
> - テストコードには、各テストが何を検証しているのかが分かるように、明確な説明（`description`）を付けてください。

**AIの応答（例）:**
```dart
// utils_test.dart
import 'package:flutter_test/flutter_test.dart';
import 'package:your_app/utils.dart'; // 実際のパスに置き換えてください

void main() {
  group('formatPrice', () {
    test('should format a positive price correctly with default currency', () {
      // Act
      final result = formatPrice(1200.5);
      // Assert
      expect(result, 'JPY 1201');
    });

    test('should throw an ArgumentError for a negative price', () {
      // Assert
      expect(() => formatPrice(-100), throwsA(isA<ArgumentError>()));
    });
  });
}
```

**なぜこれが良いのか？**
*   AIは、テストの基本パターンである**AAA (Arrange, Act, Assert)**を理解しています。
*   正常系だけでなく、エッジケース（異常系）のテストも考慮してくれます。
*   テストコードの定型的な記述をすべて自動化してくれるため、開発者は「何をテストすべきか」という本質的な部分に集中できます。

AIをリファクタリングとテストのパートナーにすることで、あなたは常に自信を持ってコードを変更し、高品質なアプリケーションを維持し続けることができるのです。