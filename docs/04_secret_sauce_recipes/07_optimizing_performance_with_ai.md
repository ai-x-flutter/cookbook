# レシピ#4-7: AIによるパフォーマンス最適化

アプリの機能が豊富になっても、動きがカクカクしたり、反応が鈍かったりすると、ユーザーはすぐに離れてしまいます。アプリの「体感速度」、すなわち**パフォーマンス**は、ユーザー満足度を決定づける重要な要素です。

しかし、パフォーマンスのボトルネック（速度低下の原因）を見つけ出し、改善するのは非常に専門的な知識を要する作業です。

このレシピでは、AIを「経験豊富なパフォーマンスエンジニア」として活用し、Flutterアプリのパフォーマンス問題を特定・解決するためのヒントを学びます。

---

## 1. Flutterのパフォーマンス診断ツール：DevTools

まず、パフォーマンス問題を調査するための最も強力な武器が、Flutterに標準で付属している**DevTools**です。特に「Performance」ビューと「CPU Profiler」ビューは、ボトルネックを発見するための鍵となります。

DevToolsの使い方の基本は、[Flutter公式ドキュメント](https://docs.flutter.dev/perf/ui-performance)に譲りますが、問題は**「DevToolsが表示する複雑なフレームグラフやCPUプロファイルのデータを、どう解釈すれば良いか」**です。ここでAIが活躍します。

## 2. AIによるボトルネックの特定

パフォーマンスが悪いと感じる画面を操作しながら、DevToolsでパフォーマンスを記録します。特にフレームレートが落ち込んでいる（グラフの赤いバーが高い）部分に注目します。

> **🤖 AI活用プロ-ンプト (パフォーマンスデータの分析依頼)**
>
> あなたは、Flutterのパフォーマンス最適化、特にDevToolsの解析に非常に詳しいエキスパートです。
>
> 私のアプリのリストスクロール性能をDevToolsで計測したところ、以下のような問題が見られました。
>
> **【状況のサマリー】**
> - `ListView.builder`で約1000件のアイテムを表示してスクロールすると、UIスレッドのフレーム描画時間が30msを超え、カクつき（ジャンク）が発生する。
> - 各リストアイテムは、画像、テキスト、複数のアイコンを含む、やや複雑な`Card`ウィジェットで構成されている。
> - CPUプロファイラを見ると、特に`build()`メソッドと`layout`フェーズに多くの時間がかかっている。
>
> **質問:**
> このような状況で、パフォーマンスのボトルネックとなっている可能性が最も高い原因は何だと考えられますか？
>
> 私が次に試すべき、具体的な改善アクションを優先順位の高い順に3つ提案してください。それぞれの改善策が、なぜ効果的なのかも説明してください。

**AIの応答（例）:**
> 承知いたしました。典型的なリストビューのパフォーマンス問題ですね。考えられる原因と対策は以下の通りです。
>
> 1.  **原因の可能性(高): build()メソッドの再実行が多すぎる**
>     - **対策:** `const`コンストラクタを最大限に活用してください。リストアイテムのウィジェットのうち、データに依存しない部分（アイコン、スタイルなど）に`const`を付けることで、不必要な再ビルドを防ぎ、描画コストを大幅に削減できます。
>
> 2.  **原因の可能性(中): レイアウト計算が複雑すぎる**
>     - **対策:** リストアイテムの高さを固定にできるなら、`ListView.builder`の`itemExtent`プロパティを設定してください。これにより、Flutterは全アイテムの高さを事前に知ることができ、スクロール時のレイアウト計算を劇的に高速化できます。
>
> 3.  **原因の可能性(低): 画像の読み込みコスト**
>     - **対策:** 画像の解像度が必要以上に大きい可能性があります。`cached_network_image`のようなパッケージを使い、一度読み込んだ画像をキャッシュしたり、表示サイズに合わせたサムネイルを生成・表示することを検討してください。

**なぜこれが良いのか？**
*   **専門知識の提供:** `const`の重要性や`itemExtent`プロパティなど、パフォーマンスチューニング特有の専門知識をAIが提供してくれます。
*   **仮説の提示:** 複雑なデータから、最も可能性の高い原因に優先順位を付けてくれるため、闇雲に修正を試す必要がなくなります。

---

## 3. AIによるリファクタリングコードの生成

ボトルネックの原因が特定できたら、その改善策を実装するコードもAIに生成させましょう。

> **🤖 AI活用プロ-ンプト (最適化コードの生成)**
>
> ありがとう。原因は`build()`メソッドの再実行が多すぎることのようです。
>
> 以下の、私のリストアイテムのウィジェットコードがあります。このコードに`const`キーワードを最大限に追加して、リビルドの回数を減らすようにリファクタリングしてください。
>
> **【元のコード】**
> ```dart
> // (ここに、constが少ない、最適化前のウィジェットコードを貼り付ける)
> ```
>
> 修正後の、パフォーマンスが最適化されたコードを提示してください。

このように、**「人間がDevToolsで現象を観察し、AIがそのデータを元に原因を推測・解説し、具体的な改善コードを生成する」**という協力体制を築くことで、専門家でなければ難しかったパフォーマンス最適化のプロセスを、誰でも体系的に進めることができるようになります。