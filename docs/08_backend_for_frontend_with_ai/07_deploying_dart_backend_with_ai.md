# レシピ#8-7: AIとデプロイするDartバックエンド (Cloud Run編)

ローカルで動作するDartバックエンドを構築しました。しかし、このままではあなたのPCが起動している間しか、あなたのアプリはサーバーと通信できません。この最終レシピでは、作成したDart Frog（またはServerpod）サーバーを、**Google Cloud Run**を使って本番環境に**デプロイ（配備）**し、世界中に公開する方法を学びます。

デプロイプロセスには、`Dockerfile`の作成やクラウドの設定など、専門的な知識が必要ですが、これもAIを「優秀なDevOpsエンジニア」として活用すれば、恐れることはありません。

---

## 1. なぜCloud Runなのか？

[Google Cloud Run](https://cloud.google.com/run)は、サーバーレスのコンテナプラットフォームです。BFFのデプロイ先として、以下のような大きなメリットがあります。

*   **サーバー管理が不要（サーバーレス）:** サーバーのOSアップデートやセキュリティパッチなどを気にする必要が一切ありません。
*   **従量課金:** リクエストが来た時にだけ課金されます。アクセスが全くない時間は、料金がほぼゼロになります。無料枠も充実しています。
*   **簡単なデプロイ:** `Dockerfile`さえ用意すれば、数コマンドでデプロイが完了します。
*   **自動スケーリング:** アクセスが増えれば自動でスケールアップし、アクセスがなくなればゼロまでスケールダウン（スケールトゥゼロ）します。

## 2. AIに`Dockerfile`を生成させる

Cloud Runにアプリをデプロイするには、まずアプリを**コンテナ**というポータブルな実行環境にパッケージングする必要があります。その「設計図」となるのが`Dockerfile`です。

> **🤖 AI活用プロンプト (Dockerfile生成)**
>
> あなたは、DockerとGoogle Cloud Runに非常に詳しいDevOpsエンジニアです。
>
> 私の**Dart Frog**バックエンドアプリケーションを、Cloud Runにデプロイするための、**最適化されたマルチステージビルドの`Dockerfile`**を生成してください。
>
> **要件:**
> 1.  ビルドステージとランタイムステージを分ける「マルチステージビルド」を採用し、最終的なコンテナイメージのサイズを最小限に抑える。
> 2.  ビルドステージでは、公式の`dart`イメージをベースに、`dart pub get`と`dart compile exe`を実行して、実行可能なバイナリを生成する。
> 3.  ランタイムステージでは、軽量な`scratch`イメージ（または`debian-slim`）をベースに、ビルドされた実行可能バイナリだけをコピーする。
> 4.  コンテナは、Cloud Runが要求する`PORT`環境変数をリッスンするように設定する（デフォルトは8080）。
>
> この`Dockerfile`の完全なコードと、各行が何をしているのかの簡単な解説をお願いします。

このプロンプトにより、本番環境での運用に耐えうる、セキュアで軽量なコンテナイメージを作成するための、専門的な`Dockerfile`が手に入ります。

---

## 3. AIにデプロイコマンドをガイドさせる

`Dockerfile`が準備できたら、あとはGoogle Cloud SDK (`gcloud` CLI) を使って、コンテナをビルドし、Cloud Runにデプロイするだけです。この一連のコマンドも、AIに尋ねましょう。

> **🤖 AI活用プロンプト (デプロイ手順ガイド)**
>
> `gcloud` CLIを使って、先ほど作成した`Dockerfile`を元に、Google Cloud Runへデプロイするための一連のコマンドを、ステップバイステップで教えてください。
>
> **前提:**
> - `gcloud` CLIはインストール済みで、Google Cloudプロジェクトへのログインも完了している。
> - Google Cloud Artifact Registry (コンテナイメージの保存場所) は有効化済み。
>
> **教えてほしいコマンド:**
> 1.  Google CloudプロジェクトIDを設定するコマンド。
> 2.  `gcloud builds submit`を使って、現在のディレクトリのソースコードからコンテナイメージをビルドし、Artifact Registryにプッシュするコマンド。
> 3.  `gcloud run deploy`を使って、ビルドしたコンテナイメージをCloud Runサービスとしてデプロイするコマンド。
>
> 各コマンドのプレースホルダー（例: `[PROJECT_ID]`, `[SERVICE_NAME]`）には、何を入れれば良いかの説明も添えてください。

AIが示したコマンドを順番に実行すれば、数分後には、あなたのDartバックエンドが、HTTPSで保護された公開URLを持ち、世界中からアクセスできる状態になります。

---

おめでとうございます！あなたは、Dartという一つの言語と、AIという強力なパートナーと共に、**アイデアの創出から、フロントエンド、バックエンドの開発、そして本番環境へのデプロイまで、アプリケーション開発の全工程**を完遂しました。

これこそが、`ai-x-flutter`が提唱する、未来のフルスタック開発の姿です。