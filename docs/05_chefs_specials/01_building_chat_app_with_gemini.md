# ケーススタディ#5-1: Gemini APIでチャットアプリを作る

このケーススタディでは、これまでに学んだすべての知識を総動員し、**Googleの最新AIモデルであるGeminiとリアルタイムで対話できる、本格的なチャットアプリ**をゼロから作り上げます。

AIにコードを書かせるだけでなく、**アプリの機能としてAIを組み込む**、まさに「AI x Flutter」を体現するプロジェクトです。

## 完成イメージ

*   ユーザーがメッセージを入力して送信すると、Gemini APIからの返信がストリーミングで表示される。
*   チャット履歴はスクロール可能。
*   送信中のメッセージはローディングインジケーターが表示される。

![チャットアプリ完成イメージ](https://storage.googleapis.com/cms-storage-bucket/images/Google_for_Developers_-_Blog_-_An.width-1500.png)
*(Image credit: Google for Developers Blog)*

## Step 1: プロジェクトのセットアップとAIとの設計相談

まずは、新しいFlutterプロジェクトを作成し、このアプリに必要な設計をAIに相談します。

> **🤖 AI活用プロンプト (プロジェクト設計)**
>
> あなたはFlutterとFirebase、そしてGoogle AIに精通したシニア開発者です。
> これから、GoogleのGemini APIとリアルタイムで対話できるチャットアプリを作ります。
>
> **要件:**
> - UIは、メッセージのリストと、下部のテキスト入力欄で構成される、一般的なチャットUI。
> - 状態管理には**Riverpod**を使用する。
> - Gemini APIとの通信には、Google公式の`google_generative_ai`パッケージを使用する。
>
> **質問:**
> 1.  このアプリに必要な、**シンプルで分かりやすいディレクトリ構成**を提案してください。
> 2.  `pubspec.yaml`に追加すべき**主要なパッケージ**をリストアップしてください。
> 3.  チャットのメッセージ一件を表す`ChatMessage`モデルクラスは、どのようなプロパティを持つべきですか？具体的なコードを提示してください。

この対話を通じて、プロジェクトの骨格と、`google_generative_ai`や`flutter_riverpod`といった必要なパッケージを決定します。

## Step 2: Gemini APIキーの取得と設定

Gemini APIを利用するには、APIキーが必要です。

1.  [Google AI Studio](https://aistudio.google.com/)にアクセスします。
2.  左側のメニューから「**Get API key**」をクリックし、新しいAPIキーを作成します。
3.  生成されたAPIキーをコピーします。**このキーは絶対に公開リポジトリなどにコミットしないでください。**

このAPIキーを安全にアプリに組み込むため、**`dart-define`**という手法を使います。

> **🤖 AI活用プロンプト (dart-defineの使い方)**
>
> Flutterアプリで、APIキーのような機密情報を安全に扱うためのベストプラクティスを教えてください。
>
> `dart-define`を使って、ビルド時にAPIキーを環境変数として埋め込む方法について、具体的なコマンド例と、Dartコード内からその値を取得する方法を説明してください。

AIの助けを借りて、`--dart-define=GEMINI_API_KEY=あなたのAPIキー` のようにしてアプリを実行し、コード内からは `String.fromEnvironment('GEMINI_API_KEY')` で安全にキーを取得する方法を学びます。

## Step 3: UIの構築

次に、チャットのUIをAIと協力して構築します。`ListView`でチャット履歴を表示し、下部に`TextField`と送信ボタンを配置する、という典型的なレイアウトです。

> **🤖 AI活用プロンプト (チャットUI作成)**
>
> あなたはFlutterのUI構築エキスパートです。
>
> 以下の要件を満たす、チャット画面のUIウィジェットを作成してください。
>
> **要件:**
> 1.  `ListView.builder`を使って、メッセージのリストを表示する。リストは逆順（`reverse: true`）に表示し、新しいメッセージが下に来るようにする。
> 2.  各メッセージは、送信者がユーザーかモデル（AI）かによって、背景色や配置（右寄せ/左寄せ）が変わるようにする。
> 3.  画面下部に、`TextField`と`IconButton`（送信ボタン）を`Row`で配置する。
> 4.  テキスト入力中は、送信ボタンを有効化する。

## Step 4: Gemini APIとの通信ロジックの実装

いよいよ、このアプリの心臓部である、Gemini APIとの通信ロジックを実装します。Geminiは、一文字ずつ応答を返す**ストリーミング**に対応しているため、これを活用してリアルタイム感を演出します。

> **🤖 AI活用プロンプト (Gemini API連携)**
>
> `google_generative_ai`パッケージを使って、Gemini Proモデルとのストリーミングチャットを実装するロジックを作成してください。
>
> **要件:**
> 1.  `GenerativeModel`を初期化する。APIキーは`dart-define`から取得する。
> 2.  過去のチャット履歴と、新しいユーザーメッセージを元に、`generateContentStream`メソッドを呼び出す。
> 3.  Streamから応答が少しずつ返ってくるたびに、UIの状態（表示するメッセージ）を更新する。
> 4.  このロジックを、Riverpodの`Notifier`クラス内に実装してください。ユーザーがメッセージを送信する`sendMessage`メソッドとして定義してください。

このプロンプトにより、非同期処理であるStreamをRiverpodで扱う、高度で実践的なコードが生成されます。AIは、Streamの`listen`の仕方や、状態の更新方法など、複雑な部分をすべて担当してくれます。

## Step 5: 全体の結合と微調整

最後に、UIとロジックを接続し、細かい部分を調整していきます。

*   送信ボタンが押されたら、Riverpodの`sendMessage`メソッドを呼び出す。
*   APIからの応答を待っている間、ローディングインジケーターを表示する。
*   メッセージの表示が更新されたら、`ListView`を一番下まで自動でスクロールさせる。

これらの「最後の仕上げ」も、AIに「`ScrollController`を使って、リストが更新されたら一番下までスクロールする方法を教えて」のように質問することで、一つずつ解決していくことができます。

---

おめでとうございます！あなたは、AIと協力して、AIそのものを活用したインタラクティブなアプリケーションを完成させました。このケーススタディを通じて学んだ「AIとの共同開発プロセス」は、今後あなたが作るあらゆるアプリに応用できる、強力な武器となるでしょう。