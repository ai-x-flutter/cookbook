# ケーススタディ#5-4: AIと作るDart製CLIツール - Cookbook自身のメンテナンス

このケーススタディは、少しユニークです。題材は、**この`cookbook`リポジトリ自身が抱えていた問題**を解決するために、AIと共にゼロから開発したコマンドラインツールです。
普通だったら、Pythonにやらすところなのですが、DartのCLIツールを開発してみました。

このレシピを作成した時に、Markdownファイルで、`**「テキスト」**`のように書かれた部分が、太字で表示されずに`**「テキスト」**`のままで表示されることに気づきました。これは、**GitHubのMarkdownレンダラーの仕様**によるもので、単純な修正では解決できない問題でした。

このレシピでは、この問題を解決するための**カスタムlintツール**を、AIとの対話を通じて構築したプロセスを追体験します。

## このレシピで学べること

*   Flutterアプリだけではない、**Dartのもう一つの顔（CLIツール開発）**。
*   ファイルシステムの操作 (`dart:io`) や、外部コマンド（`git`）の実行方法。
*   正規表現(`RegExp`)を使った、高度な文字列パターンの解析と置換。
*   AIに**複雑な問題を定義し、それを解決するアルゴリズムをコードに落とし込ませる**、実践的なプロセス。

## Step 1: 問題の定義と正しいアルゴリズムの発見

最初、AIはこの問題を単純なエスケープの問題だと考えていました。しかし、AIとの対話と試行錯誤を重ねる中で、真の原因がもっと深い場所にあることに気づきました。

**真の原因:** GitHubのMarkdownレンダラーは、`**`で囲まれたテキストが、特定の括弧文字（`「`, `（`など）で始まると、それを強調構文として正しく解釈できない。

**解決策:** この問題を確実に回避するには、`**「テキスト」**`という書き方を、パーサーが絶対に誤解しない`「**テキスト**」`という形式に、機械的に変換する必要がある。

この最終的な解決策にたどり着いた後、私たちはこのロジックを実装するツールをAIに依頼しました。

> **🤖 AI活用プロンプト (CLIツールの仕様定義)**
>
> あなたは、DartでのCLIツール開発と、正規表現に非常に詳しいエキスパートです。
>
> 私のGitリポジトリ内にある、すべてのMarkdownファイル (`.md`) をスキャンし、GitHub Flavored Markdown (GFM)との互換性問題を修正するコマンドラインツールを作成したい。
>
> **ツールの要件:**
> 1.  コマンドライン引数として、スキャン対象のリポジトリのパスと、`--dry-run`オプションを受け取れるようにする。
> 2.  `git ls-files`コマンドを使い、Gitで追跡されているMarkdownファイルのみを対象にする。
> 3.  **修正ロジック:**
>     - ファイル内で `\*\*(.*?)\*\*` にマッチする全ての箇所を見つけ出す。
>     - マッチした部分の中身が、特定の開始括弧（`「`, `（`, `『`, `【`）で始まっている場合は、括弧が`**`の外側に来るように再フォーマットする。
      - 対応する終了括弧（`」`, `）`, `』`, `】`）で終わる場合には、括弧が`**`の外側に来るように再フォーマットする。
>     - 上記の条件に当てはまらない、通常の太字（例: `**テキスト**`）には、変更を加えない。
> 4.  この要件を満たす、**完全なDartのCLIアプリケーション**のコードを生成してください。`args`パッケージを使い、`pubspec.yaml`と、`bin/`ディレクトリに置くメインのDartファイルの両方を含めてください。

## Step 2: AIが生成したコードのレビューと実行

この詳細なプロンプトにより、AIは私たちが長い時間をかけてたどり着いたアルゴリズムを、忠実に実装したDartコードを生成しました。

生成されたコードが、`examples/markdown_fixer_cli`にあります。
このツールは、正規表現を使って全ての太字ブロックを抽出し、一つ一つに対して私たちの定義した条件をチェックし、条件に合致するものだけを安全に修正するという、洗練された動作をします。


このツールは、このCookbookを読むだけでなく、あなた自身の他のMarkdownベースのプロジェクトでも、同様の問題を解決するために利用することができます。

---

このケーススタディは、AIが単なるコードスニペットの生成機ではなく、**人間との対話を通じて問題を深く理解し、複雑で特殊な要求を満たす、洗練されたツールを構築できる、強力な開発パートナー**であることを示しています。

---

### ツールの使い方

この`markdown_fixer_cli`ツールは、あなたのPCにDart SDKさえインストールされていれば、簡単に利用できます。

#### 1. 準備

まず、ターミナルで`examples/markdown_fixer_cli`ディレクトリに移動し、必要なパッケージをインストールします。

```bash
# cookbookリポジトリのルートにいる場合
cd examples/markdown_fixer_cli
dart pub get
```

#### 2. ドライラン（Dry Run）で修正箇所を確認する

**【重要】** 実際にファイルを変更する前に、まず**ドライランモード**で実行し、どのファイルに、どのような修正が加えられるのかを確認することを強く推奨します。

`dart run`コマンドを使い、`--path`オプションで修正したいリポジトリのパスを指定し、`--dry-run`フラグを付けます。

```bash
# dart run bin/maintainer.dart --path <修正したいリポジトリへのパス> --dry-run
```

**実行例（cookbookリポジトリ自身をチェックする場合）:**
```bash
# markdown_fixer_cli ディレクトリにいる状態で...
# ../../ は、2つ上の階層、つまりcookbookリポジトリのルートを指す
dart run bin/maintainer.dart --path ../../ --dry-run
```

**ドライランの出力例:**
```
--- Markdown GFM互換性修正プログラム (Dart版) ---
🔍 ターゲットディレクトリ: ../../
👕 ドライランモードで実行します。ファイルは変更されません。
----------------------------------------
✅ Gitリポジトリ内で 52 個のMarkdownファイルを検出しました。
❗ GFM互換性の問題を docs/09_ai_for_design_and_prototyping/01_creating_a_design_system_with_ai.md で発見しました。
   -> (ドライランのため、変更はスキップしました)
----------------------------------------
👕 ドライラン完了。合計 1 個のファイルで問題が発見されました。
実際に修正するには、--dry-runオプションを外して再度実行してください。
--- プログラムを終了します ---
```

#### 3. 修正の実行

ドライランの結果に問題がなければ、`--dry-run`フラグを外してコマンドを再実行します。これにより、実際のファイルが修正され、上書き保存されます。

```bash
dart run bin/maintainer.dart --path ../../
```

**実行出力例:**
```
...
❗ GFM互換性の問題を docs/09_ai_for_design_and_prototyping/01_creating_a_design_system_with_ai.md で発見しました。
   -> ✅ ファイルを修正し、上書き保存しました。
...
🎉 完了！合計 1 個のファイルを修正しました。
git diff で変更内容を確認し、問題がなければコミット＆プッシュしてください。
...
```

#### 4. 変更内容の確認とコミット

ツールによる修正が完了したら、Gitを使って変更内容を確認し、リポジトリに反映させます。

```bash
# まず、cookbookリポジトリのルートに戻る
cd ../../

# どのファイルが変更されたかを確認
git status

# 変更内容の詳細を確認
git diff

# 問題がなければ、変更をコミット
git add .
git commit -m "Docs: Apply GFM compatibility fixes using markdown_fixer_cli"

# リモートリポジトリにプッシュ
git push
```

これで、あなたのリポジトリのMarkdownファイルは、GitHub上で正しく表示されるようになります。